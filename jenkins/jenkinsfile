pipeline {
    agent any

    environment {
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        IMAGE_NAME = "mern-app"
        FULL_IMAGE = "${IMAGE_NAME}:${IMAGE_TAG}"
    }

    options {
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {

        stage('Build Docker Image') {
            steps {
                script {
                    echo "üî® Construction de l'image : ${FULL_IMAGE}"
                    sh "docker build -t ${FULL_IMAGE} ."
                }
            }
        }

        stage('Setup Kind Cluster') {
            steps {
                script {
                    echo "‚òÅÔ∏è D√©marrage du cluster Kind (mern-cluster)..."
                    sh 'kind delete cluster --name mern-cluster || true'
                    sh 'kind create cluster --name mern-cluster'
                    sh 'kubectl cluster-info --context kind-mern-cluster'
                }
            }
        }

        stage('Load Image into Kind') {
            steps {
                script {
                    echo "üì¶ Chargement de l'image ${FULL_IMAGE} dans Kind..."
                    sh "kind load docker-image ${FULL_IMAGE} --name mern-cluster"
                }
            }
        }

        // --- BLOC MODIFI√â ICI ---
        stage('Deploy with Terraform') {
            steps {
                dir('jenkins/terraform') {
                    script {
                        echo "üöÄ D√©ploiement avec Terraform..."
                        sh """
                            echo "üîπ Init Terraform..."
                            terraform init

                            echo "üîπ Apply Terraform..."
                            terraform apply -auto-approve -var="image_tag=${IMAGE_TAG}"
                        """
                    }
                }
            }
        }
    }
}

