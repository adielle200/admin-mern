pipeline {
    agent any

    environment {
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        FRONT_IMAGE = "mern-frontend:${IMAGE_TAG}"
        BACK_IMAGE = "mern-backend:${IMAGE_TAG}"
    }

    options {
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {

        stage('Build Frontend Docker Image') {
            steps {
                script {
                    echo "üî® Construction de l'image FRONTEND : ${FRONT_IMAGE}"
                    sh "docker build -t ${FRONT_IMAGE} frontend"
                }
            }
        }

        stage('Build Backend Docker Image') {
            steps {
                script {
                    echo "üî® Construction de l'image BACKEND : ${BACK_IMAGE}"
                    sh "docker build -t ${BACK_IMAGE} backend"
                }
            }
        }

        stage('Setup Kind Cluster') {
            steps {
                script {
                    echo "‚òÅÔ∏è D√©marrage du cluster Kind (mern-cluster)..."
                    sh 'kind delete cluster --name mern-cluster || true'
                    sh 'kind create cluster --name mern-cluster'
                    sh 'kubectl cluster-info --context kind-mern-cluster'
                }
            }
        }

        stage('Load Images into Kind') {
            steps {
                script {
                    echo "üì¶ Chargement de ${FRONT_IMAGE} et ${BACK_IMAGE} dans Kind..."
                    sh "kind load docker-image ${FRONT_IMAGE} --name mern-cluster"
                    sh "kind load docker-image ${BACK_IMAGE} --name mern-cluster"
                }
            }
        }

        stage('Deploy with Terraform') {
            steps {
                dir('terraform') {
                    script {
                        echo "üöÄ D√©ploiement avec Terraform..."
                        sh """
                            terraform init
                            terraform apply -auto-approve \
                                -var="frontend_image_tag=${IMAGE_TAG}" \
                                -var="backend_image_tag=${IMAGE_TAG}"
                        """
                    }
                }
            }
        }
    }
}

